const fs = require('fs');
const path = require('path');

class CustomMarkdownReporter {
  constructor() {
    this.results = [];
    this.startTime = null;
    this.endTime = null;
  }

  onBegin(config, suite) {
    this.startTime = new Date();
    console.log(`\nğŸš€ Starting test execution at ${this.startTime.toISOString()}`);
    console.log(`ğŸ“ Running ${suite.allTests().length} tests\n`);
  }

  onTestBegin(test) {
    console.log(`â–¶ï¸  Running: ${test.title}`);
  }

  onTestEnd(test, result) {
    const status = result.status === 'passed' ? 'âœ… Passed' : 'âŒ Failed';
    console.log(`   ${status} (${result.duration}ms)`);

    let input = '';
    let expected = '';
    let output = '';

    for (const attachment of result.attachments) {
      if (attachment.name === 'input' && attachment.body) {
        input = attachment.body.toString();
      } else if (attachment.name === 'expected' && attachment.body) {
        expected = attachment.body.toString();
      } else if (attachment.name === 'output' && attachment.body) {
        output = attachment.body.toString();
      }
    }

    this.results.push({
      title: test.title,
      status: result.status,
      duration: result.duration,
      error: result.error ? result.error.message : null,
      input,
      expected,
      output
    });
  }

  onEnd(result) {
    this.endTime = new Date();
    const totalDuration = this.endTime - this.startTime;

    const passed = this.results.filter(r => r.status === 'passed').length;
    const failed = this.results.filter(r => r.status === 'failed').length;
    const skipped = this.results.filter(r => r.status === 'skipped').length;

    console.log(`\nğŸ“Š Test Execution Summary`);
    console.log(`   Total: ${this.results.length}`);
    console.log(`   âœ… Passed: ${passed}`);
    console.log(`   âŒ Failed: ${failed}`);
    console.log(`   â­ï¸  Skipped: ${skipped}`);
    console.log(`   â±ï¸  Duration: ${totalDuration}ms\n`);

    this.generateMarkdownReport(passed, failed, skipped, totalDuration);
  }

  generateMarkdownReport(passed, failed, skipped, totalDuration) {
    const reportPath = path.join(process.cwd(), 'test-report.md');

    let markdown = `# Tamil Transliteration Test Report\n\n`;
    markdown += `**Generated:** ${new Date().toISOString()}\n\n`;
    markdown += `## ğŸ“Š Summary\n\n`;
    markdown += `| Metric | Value |\n`;
    markdown += `|--------|-------|\n`;
    markdown += `| Total Tests | ${this.results.length} |\n`;
    markdown += `| âœ… Passed | ${passed} |\n`;
    markdown += `| âŒ Failed | ${failed} |\n`;
    markdown += `| â­ï¸ Skipped | ${skipped} |\n`;
    markdown += `| â±ï¸ Total Duration | ${totalDuration}ms |\n\n`;

    markdown += `## ğŸ“‹ Test Results\n\n`;

    for (const result of this.results) {
      const statusIcon = result.status === 'passed' ? 'âœ…' : result.status === 'failed' ? 'âŒ' : 'â­ï¸';
      markdown += `### ${statusIcon} ${result.title}\n\n`;
      markdown += `- **Status:** ${result.status.toUpperCase()}\n`;
      markdown += `- **Duration:** ${result.duration}ms\n`;

      if (result.input) {
        markdown += `- **Input:** \`${result.input}\`\n`;
      }
      if (result.expected) {
        markdown += `- **Expected:** \`${result.expected}\`\n`;
      }
      if (result.output) {
        markdown += `- **Output:** \`${result.output}\`\n`;
      }

      if (result.error) {
        markdown += `\n**Error:**\n\`\`\`\n${result.error}\n\`\`\`\n`;
      }

      markdown += `\n---\n\n`;
    }

    markdown += `## ğŸ”— Additional Reports\n\n`;
    markdown += `- [HTML Report](./playwright-report/index.html)\n`;
    markdown += `- [Test Results](./test-results/)\n\n`;
    markdown += `---\n\n`;
    markdown += `*Report generated by Custom Markdown Reporter*\n`;

    fs.writeFileSync(reportPath, markdown);
    console.log(`ğŸ“ Markdown report generated: ${reportPath}`);
  }
}

module.exports = CustomMarkdownReporter;
